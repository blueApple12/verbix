<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verbix Whisper Pro</title>
<style>
    body { margin: 0; padding: 0; background: #000; color: #ffdca8; font-family: sans-serif; text-align: center; overflow: hidden; }
    #menu { padding: 20px; display: flex; flex-direction: column; align-items: center; background: radial-gradient(circle, #2b1407, #000); height: 100vh; }
    input { margin: 10px; padding: 15px; width: 85%; border-radius: 10px; border: 1px solid #d69a3c; font-size: 16px; background: #1a0a04; color: white; }
    button { margin-top: 20px; padding: 15px 45px; font-size: 22px; border-radius: 15px; background: #d69a3c; color: #000; font-weight: bold; cursor: pointer; border: none; }
    #blackout { position: fixed; inset: 0; background: black; z-index: 9999; display: none; touch-action: none; }
    #searchFrame { position: fixed; inset: 0; width: 100%; height: 100%; border: none; display: none; z-index: 9998; }
    .status-dot { position: fixed; bottom: 6px; right: 6px; width: 4px; height: 4px; background: #111; border-radius: 50%; z-index: 10000; }
</style>
</head>
<body>

<div id="menu">
    <h1 style="text-shadow: 0 0 10px #d69a3c;">VERBIX</h1>
    <input id="hfToken" type="password" placeholder="Hugging Face Token (hf_...)">
    <input id="startWord" placeholder="Trigger Start (e.g. 'המילה היא')">
    <input id="endWord" placeholder="Trigger End (e.g. 'בחירה חופשית')">
    <button id="startBtn">ACTIVATE</button>
</div>

<iframe id="searchFrame" src=""></iframe>
<div id="blackout"></div>
<div class="status-dot" id="dot"></div>

<script>
const $ = id => document.getElementById(id);
let STARTS = [], ENDS = [], currentWord = "", HF_TOKEN = "";
let mediaRecorder, audioChunks = [], listening = false;

const vib = (p) => { if ("vibrate" in navigator) navigator.vibrate(p); };
const setDot = (c) => { $("dot").style.background = c; };

// 1. Swipe Reveal & Triple-Tap Reset
let tStart = 0, lastTap = 0, tapCount = 0;
$("blackout").addEventListener('touchstart', e => { 
    tStart = e.touches[0].clientY; 
    const now = Date.now();
    if (now - lastTap < 400) tapCount++; else tapCount = 1;
    lastTap = now;
    if (tapCount === 3) location.reload(); 
});
$("blackout").addEventListener('touchend', e => {
    if (tStart - e.changedTouches[0].clientY > 100) revealSearch();
});

function revealSearch() {
    if (!currentWord) { vib(50); return; }
    $("blackout").style.display = "none";
    $("searchFrame").style.display = "block";
}

// 2. Optimized Whisper Call
async function queryWhisper(blob) {
    setDot("#f00"); // Red = Thinking
    try {
        const response = await fetch(
            "https://api-inference.huggingface.co/models/openai/whisper-large-v3-turbo",
            {
                headers: { Authorization: `Bearer ${HF_TOKEN}` }, // No Content-Type, let API auto-detect
                method: "POST",
                body: blob,
            }
        );
        const result = await response.json();
        
        // If model is loading, it returns an "estimated_time"
        if (result.error && result.error.includes("currently loading")) {
            console.log("Model waking up...");
            return; 
        }

        if (result.text) processText(result.text.toLowerCase());
    } catch (e) { console.error("API Fail", e); }
    setDot("#111"); 
}

function processText(text) {
    console.log("Whisper Heard:", text);
    // Logic for END triggers (captures word BEFORE)
    ENDS.forEach(p => {
        if (text.includes(p)) {
            let parts = text.split(p);
            let words = parts[parts.length - 2].trim().split(/\s+/);
            updateWord(words[words.length - 1]);
        }
    });
    // Logic for START triggers (captures word AFTER)
    STARTS.forEach(p => {
        if (text.includes(p)) {
            let parts = text.split(p);
            let words = parts[1].trim().split(/\s+/);
            updateWord(words[0]);
        }
    });
}

function updateWord(word) {
    word = word.replace(/[.,!?]/g, "");
    if (!word || word === currentWord) return;
    currentWord = word;
    // Load search in background
    $("searchFrame").src = `https://www.google.com/search?q=${encodeURIComponent(word)}&igu=1`;
    vib([150, 50, 150]); // Success vibration
}

// 3. Audio Handling (Universal Codec)
async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    // Auto-detect best supported format
    const types = ['audio/webm', 'audio/mp4', 'audio/ogg', 'audio/wav'];
    const supportedType = types.find(t => MediaRecorder.isTypeSupported(t));
    
    mediaRecorder = new MediaRecorder(stream, { mimeType: supportedType });
    
    mediaRecorder.ondataavailable = e => {
        audioChunks.push(e.data);
        if (mediaRecorder.state === "inactive") {
            const blob = new Blob(audioChunks, { type: supportedType });
            queryWhisper(blob);
            audioChunks = [];
            if(listening) restartRec();
        }
    };

    const restartRec = () => {
        if (!listening) return;
        try {
            setDot("#050"); // Green flash = Recording
            mediaRecorder.start();
            // 5-second capture window
            setTimeout(() => { if(mediaRecorder.state === "recording") mediaRecorder.stop(); }, 5000);
        } catch(e) {}
    };
    
    restartRec();
}

// 4. Start
$("startBtn").onclick = async () => {
    HF_TOKEN = $("hfToken").value;
    STARTS = $("startWord").value.split(",").map(s => s.trim().toLowerCase());
    ENDS = $("endWord").value.split(",").map(s => s.trim().toLowerCase());
    
    if(!HF_TOKEN.startsWith("hf_")) return alert("Token must start with hf_");

    localStorage.setItem("verbix_start", $("startWord").value);
    localStorage.setItem("verbix_end", $("endWord").value);
    localStorage.setItem("verbix_token", HF_TOKEN);

    $("menu").style.display = "none";
    $("blackout").style.display = "block";
    
    listening = true;
    startRecording();
    vib(100);
    try { await document.documentElement.requestFullscreen(); } catch(e) {}
};

// Persistence
$("startWord").value = localStorage.getItem("verbix_start") || "";
$("endWord").value = localStorage.getItem("verbix_end") || "";
$("hfToken").value = localStorage.getItem("verbix_token") || "";
</script>
</body>
</html>
