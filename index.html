<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verbix Pro</title>

<style>
body {
    margin: 0;
    padding: 0;
    background: radial-gradient(circle, #2b1407, #120804 70%);
    color: #ffdca8;
    font-family: Georgia, serif;
    text-align: center;
    overflow: hidden;
}

h1 {
    margin-top: 30px;
    font-size: 38px;
    letter-spacing: 3px;
    text-shadow: 0 0 12px #ffbf66;
}

.panel {
    margin-top: 40px;
}

label {
    display: block;
    margin-top: 25px;
    font-size: 18px;
}

input {
    margin-top: 8px;
    padding: 10px;
    font-size: 18px;
    width: 80%;
    max-width: 400px;
    border-radius: 8px;
    border: none;
}

button {
    margin-top: 40px;
    padding: 14px 40px;
    font-size: 22px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(180deg, #ffda8b, #d69a3c);
    color: #4a2a0f;
    font-weight: bold;
    cursor: pointer;
}

#blackout {
    position: fixed;
    inset: 0;
    background: black;
    z-index: 9999;
    display: none;
}
</style>
</head>

<body>

<h1>VERBIX</h1>

<div class="panel" id="menu">
    <label>
        <input id="startWord" placeholder="Start Phrase">
    </label>

    <label>
        <input id="endWord" placeholder="End Phrase">
    </label>

    <button id="startBtn">Start</button>
</div>

<div id="blackout"></div>

<script>
const $ = id => document.getElementById(id);

// Restore saved values
$("startWord").value = localStorage.getItem("verbix_start") || "";
$("endWord").value   = localStorage.getItem("verbix_end")   || "";

let wakeLock = null;

async function enableWakeLock() {
    try {
        if ("wakeLock" in navigator) {
            wakeLock = await navigator.wakeLock.request("screen");
        }
    } catch {}
}

function releaseWakeLock() {
    try {
        wakeLock?.release();
        wakeLock = null;
    } catch {}
}

// ======================
// Robust Speech Recognition
// ======================
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let listening = false;

let STARTS = [];
let ENDS = [];

if (SR) {
    recognition = new SR();
    recognition.lang = "he-IL";
    recognition.continuous = true;
    recognition.interimResults = true; 
    recognition.maxAlternatives = 1;

    recognition.onresult = e => {
        // We take the very last result to avoid background noise "buildup"
        const result = e.results[e.results.length - 1];
        const text = result[0].transcript.trim().toLowerCase();
        handleSpeech(text);
    };

    // If it stops due to noise/silence, force it back on immediately
    recognition.onend = () => {
        if (listening) {
            try { recognition.start(); } catch(e) {}
        }
    };

    recognition.onerror = (event) => {
        if(event.error === 'no-speech') {
            // Keep going
        }
    };
}

function startListening() {
    if (!recognition || listening) return;
    listening = true;
    
    // Vibrate once to let you know it's "live" in your pocket
    if ("vibrate" in navigator) navigator.vibrate(50);
    
    recognition.start();
}

function cleanWords(txt) {
    return txt.replace(/[.,!?״”“]/g, "").trim().split(/\s+/);
}

function handleSpeech(text) {
    // Check END phrases
    for (const phrase of ENDS) {
        if (text.includes(phrase)) {
            const idx = text.indexOf(phrase);
            const before = text.slice(0, idx).trim();
            const words = cleanWords(before);
            const word = words[words.length - 1];
            if (word) return finish(word);
        }
    }

    // Check START phrases
    for (const phrase of STARTS) {
        if (text.includes(phrase)) {
            const idx = text.indexOf(phrase);
            const after = text.slice(idx + phrase.length).trim();
            const words = cleanWords(after);
            const word = words[0];
            if (word) return finish(word);
        }
    }
}

function finish(word) {
    listening = false;
    
    // Vibrate: Double pulse confirms success
    if ("vibrate" in navigator) {
        navigator.vibrate([300, 100, 300]);
    }

    recognition.stop();
    releaseWakeLock();

    setTimeout(() => {
        location.replace(
            "https://www.google.com/search?q=" +
            encodeURIComponent(word)
        );
    }, 200);
}

// ======================
// Setup & Start
// ======================
$("startBtn").onclick = async () => {
    STARTS = $("startWord").value.split(",").map(s => s.trim().toLowerCase()).filter(Boolean);
    ENDS = $("endWord").value.split(",").map(s => s.trim().toLowerCase()).filter(Boolean);

    if (!STARTS.length && !ENDS.length) {
        alert("Please set at least one phrase.");
        return;
    }

    localStorage.setItem("verbix_start", $("startWord").value.trim());
    localStorage.setItem("verbix_end", $("endWord").value.trim());

    try { await document.documentElement.requestFullscreen(); } catch {}
    enableWakeLock();

    $("menu").style.display = "none";
    $("blackout").style.display = "block";

    startListening();
};
</script>

</body>
</html>
