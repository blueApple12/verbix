<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verbix Pro</title>
<style>
    body { margin: 0; padding: 0; background: #000; color: #ffdca8; font-family: serif; text-align: center; overflow: hidden; }
    #menu { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; background: radial-gradient(circle, #2b1407, #000); height: 100vh; }
    h1 { font-size: 45px; text-shadow: 0 0 15px #d69a3c; margin-bottom: 40px; }
    input { margin: 12px; padding: 15px; width: 80%; border-radius: 10px; border: 1px solid #d69a3c; font-size: 18px; background: #1a0a04; color: white; }
    button { margin-top: 30px; padding: 18px 50px; font-size: 24px; border-radius: 15px; background: linear-gradient(180deg, #ffda8b, #d69a3c); color: #4a2a0f; font-weight: bold; cursor: pointer; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    #blackout { position: fixed; inset: 0; background: black; z-index: 9999; display: none; touch-action: none; }
    #searchFrame { position: fixed; inset: 0; width: 100%; height: 100%; border: none; display: none; z-index: 9998; }
    .indicator { position: fixed; bottom: 8px; right: 8px; width: 5px; height: 5px; background: #111; border-radius: 50%; z-index: 10000; }
</style>
</head>
<body>

<div id="menu">
    <h1>VERBIX</h1>
    <input id="startWord" placeholder="Trigger Start (e.g. 'המילה היא')">
    <input id="endWord" placeholder="Trigger End (e.g. 'בחירה חופשית')">
    <button id="startBtn">ACTIVATE</button>
</div>

<iframe id="searchFrame"></iframe>
<div id="blackout"></div>
<div class="indicator" id="dot"></div>

<script>
// ==========================================
// CONFIGURATION - PASTE YOUR TOKEN BELOW
// ==========================================
const HF_TOKEN = "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"; 
const MODEL_URL = "https://api-inference.huggingface.co/models/openai/whisper-large-v3-turbo";

const $ = id => document.getElementById(id);
let STARTS = [], ENDS = [], currentWord = "";
let mediaRecorder, audioChunks = [], listening = false;

const vib = (p) => { if ("vibrate" in navigator) navigator.vibrate(p); };
const setDot = (c) => { $("dot").style.background = c; };

// 1. Swipe Reveal Logic
let tStart = 0;
$("blackout").addEventListener('touchstart', e => { tStart = e.touches[0].clientY; });
$("blackout").addEventListener('touchend', e => {
    if (tStart - e.changedTouches[0].clientY > 100) {
        if (!currentWord) { vib(50); return; }
        $("blackout").style.display = "none";
        $("searchFrame").style.display = "block";
    }
});

// 2. AI Whisper Logic
async function callWhisper(blob) {
    setDot("#300"); // Thinking...
    try {
        const response = await fetch(MODEL_URL, {
            headers: { Authorization: `Bearer ${HF_TOKEN}`, "Content-Type": "audio/flac" },
            method: "POST", body: blob,
        });
        const res = await response.json();
        if (res.text) processText(res.text.toLowerCase());
    } catch (e) { console.error(e); }
    setDot("#111");
}

function processText(text) {
    console.log("Heard:", text);
    // Logic for capturing word before/after triggers
    ENDS.forEach(p => {
        if (text.includes(p)) {
            let seg = text.split(p)[text.split(p).length - 2].trim().split(/\s+/);
            updateWord(seg[seg.length - 1]);
        }
    });
    STARTS.forEach(p => {
        if (text.includes(p)) {
            let seg = text.split(p)[1].trim().split(/\s+/);
            updateWord(seg[0]);
        }
    });
}

function updateWord(word) {
    word = word.replace(/[.,!?]/g, "");
    if (!word || word === currentWord) return;
    currentWord = word;
    $("searchFrame").src = `https://www.google.com/search?q=${encodeURIComponent(word)}&igu=1`;
    vib([150, 50, 150]); // The "Got it" vibration
}

// 3. Audio Recording Loop (4s Chunks)
async function startAudio() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    
    mediaRecorder.ondataavailable = e => {
        audioChunks.push(e.data);
        if (mediaRecorder.state === "inactive") {
            const blob = new Blob(audioChunks, { type: 'audio/flac' });
            callWhisper(blob);
            audioChunks = [];
            if(listening) runCycle();
        }
    };

    const runCycle = () => {
        try {
            mediaRecorder.start();
            setTimeout(() => { if(mediaRecorder.state === "recording") mediaRecorder.stop(); }, 4000);
        } catch(e) {}
    };
    runCycle();
}

// 4. Initialization
$("startBtn").onclick = async () => {
    STARTS = $("startWord").value.split(",").map(s => s.trim().toLowerCase());
    ENDS = $("endWord").value.split(",").map(s => s.trim().toLowerCase());
    
    localStorage.setItem("verbix_start", $("startWord").value);
    localStorage.setItem("verbix_end", $("endWord").value);

    $("menu").style.display = "none";
    $("blackout").style.display = "block";
    
    listening = true;
    startAudio();
    vib(100); // System Ready vibe
    try { await document.documentElement.requestFullscreen(); } catch(e) {}
};

// Persistence
$("startWord").value = localStorage.getItem("verbix_start") || "";
$("endWord").value = localStorage.getItem("verbix_end") || "";
</script>
</body>
</html>
