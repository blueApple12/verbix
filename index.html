<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Verbix PRO</title>
    <style>
        :root { --gold: #d69a3c; --bg: #050301; --deep: #a35d14; }
        body { margin: 0; background: var(--bg); color: #ffdca8; font-family: system-ui, sans-serif; overflow: hidden; height: 100vh; }
        canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
        #menu { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        h1 { font-size: 70px; margin: 0; font-weight: 900; background: linear-gradient(to bottom, #fff, var(--gold), #4c2b0a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        input { width: 85%; max-width: 380px; padding: 16px; margin: 8px; border-radius: 15px; border: 1px solid #333; background: rgba(10,10,10,.8); color: #fff; text-align: center; font-size: 18px; outline: none; }
        button { margin-top: 25px; padding: 18px 80px; border-radius: 50px; background: linear-gradient(var(--gold), var(--deep)); color: #000; font-weight: bold; border: none; font-size: 20px; cursor: pointer; }
        #blackout { position: fixed; inset: 0; background: #000; z-index: 99; display: none; touch-action: none; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="menu">
    <h1>VERBIX</h1>
    <input id="triggerInput" placeholder="Trigger Word (e.g. נכון)">
    <button id="startBtn">ACTIVATE</button>
</div>
<div id="blackout"></div>

<script>
const $ = id => document.getElementById(id);
const dom = { menu: $("menu"), blackout: $("blackout"), startBtn: $("startBtn"), trigger: $("triggerInput") };
const vib = p => navigator.vibrate?.(p);

let state = { listening: false, lastWord: "", trigger: "" };

/* --- SPEECH ENGINE --- */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec;

if (SR) {
    rec = new SR();
    rec.lang = "he-IL"; 
    rec.continuous = true; 
    rec.interimResults = true;

    rec.onresult = e => {
        const transcript = [...e.results].map(r => r[0].transcript).join(" ").toLowerCase();
        const words = transcript.replace(/[.,!?״"']/g, "").split(/\s+/).filter(Boolean);
        
        if (words.length > 0) {
            // Always track the very last word for the manual tap safety net
            state.lastWord = words[words.length - 1];

            // Check for the trigger word
            if (state.trigger) {
                const tIndex = words.lastIndexOf(state.trigger);
                // If trigger is found and there's a word before it
                if (tIndex > 0) {
                    reveal(words[tIndex - 1]);
                }
            }
        }
    };
    rec.onend = () => state.listening && rec.start();
}

/* --- REVEAL ACTION --- */
function reveal(word) {
    if (!word || !state.listening) return;
    state.listening = false; 
    vib([60, 100, 60]);
    
    // Redirect to real Google
    location.href = `https://www.google.com/search?q=${encodeURIComponent(word)}`;
}

/* --- MANUAL TAP SAFETY NET --- */
dom.blackout.onclick = () => {
    // If we are on the blackout screen and tap, reveal the last word heard
    if (state.lastWord) {
        reveal(state.lastWord);
    } else {
        vib(40); // Shorter buzz means "Nothing heard yet"
    }
};

/* --- SWIPE UP TO RESET --- */
let sY = 0;
dom.blackout.ontouchstart = e => sY = e.touches[0].clientY;
dom.blackout.ontouchend = e => {
    if (sY - e.changedTouches[0].clientY > 100) location.reload();
};

/* --- START --- */
dom.startBtn.onclick = () => {
    state.trigger = dom.trigger.value.trim().toLowerCase();
    dom.menu.style.display = "none";
    dom.blackout.style.display = "block";
    state.listening = true;
    rec?.start();
    vib(100);
    // Try to enter fullscreen for better cover
    document.documentElement.requestFullscreen?.().catch(()=>{});
};

/* --- BACKGROUND ANIM --- */
const ctx = $("canvas").getContext("2d");
const resize = () => { $("canvas").width = innerWidth; $("canvas").height = innerHeight; };
window.onresize = resize; resize();
class P {
    constructor() { this.reset(); }
    reset() { this.x = Math.random()*innerWidth; this.y = Math.random()*innerHeight; this.v = Math.random()*0.3+0.1; this.o = Math.random(); }
    draw() { this.y-=this.v; this.o-=0.002; if(this.o<=0)this.reset(); ctx.fillStyle=`rgba(214,154,60,${this.o})`; ctx.beginPath(); ctx.arc(this.x,this.y,1.5,0,7); ctx.fill(); }
}
const pts = Array.from({length:40}, () => new P());
(function anim(){ ctx.clearRect(0,0,innerWidth,innerHeight); pts.forEach(p=>p.draw()); requestAnimationFrame(anim); })();
</script>
</body>
</html>
